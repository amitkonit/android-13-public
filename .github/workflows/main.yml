# .github/workflows/build.yml
name: Android 13 Docker Build

on:
  workflow_dispatch:
  push:
    branches: [ main ]

concurrency:
  group: android13-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    # Your runner should be an x86_64 Ubuntu 22.04+ box with â‰¥64GB RAM.
    # Give it labels like: self-hosted, linux, x64
    runs-on: [self-hosted, linux, x64]
    timeout-minutes: 720

    permissions:
      contents: read

    steps:
      - name: Prep host (Docker & Git LFS)
        run: |
          sudo apt-get update
          sudo apt-get install -y git-lfs docker.io
          sudo git lfs install --system
          sudo systemctl enable --now docker || true
          sudo usermod -aG docker $USER || true

      - name: Checkout (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Show environment (sanity check)
        run: |
          uname -a
          lsb_release -a || cat /etc/os-release
          nproc
          free -h
          df -h

      - name: Build (inside Docker via repo scripts)
        run: |
          chmod +x build_docker_android.sh build_docker_tar.sh
          ./build_docker_android.sh -A
          sudo ./build_docker_tar.sh

      - name: Collect artifacts
        run: |
          mkdir -p artifacts
          # copy every produced tar into artifacts/
          find IMAGE -type f -name '*.tar' -print -exec cp -v {} artifacts/ \;

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android13-docker-tars-${{ github.run_number }}
          path: artifacts
          if-no-files-found: error
          retention-days: 14

      - name: Cleanup Docker space (optional)
        if: always()
        run: |
          docker system prune -af || true
